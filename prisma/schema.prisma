generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserType {
  PRIVATE
  BUSINESS
}

enum PropertyStatus {
  DRAFT
  ACTIVE
  RESERVED
}

enum ListingType {
  SALE
  RENT
}

enum PropertyType {
  APARTMENT
  HOUSE
  ROOM
  STUDIO
  LOFT
  DORM
}

enum ReportReason {
  SPAM
  SCAM
  INAPPROPRIATE_BEHAVIOR
  FAKE_PROFILE
  MISLEADING_INFORMATION
  OTHER
}

model User {
  id                    String   @id @default(uuid())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  email                 String   @unique
  contactEmail          String?
  password              String?
  firstName             String?
  lastName              String?
  age                   Int?
  profileImage          String?
  smoker                Boolean?
  pets                  Boolean?
  budgetMax             Int?
  propertyId            String?
  emailVerificationCode String   @unique
  emailVerified         Boolean  @default(true)
  profileVisible        Boolean  @default(false)
  provider              String?
  providerAccountId     String?
  passwordResetCode     String?  @unique
  bgImage               String?
  description           String?
  gender                String?
  moodboardImages       Json     @default("[]")
  phone                 String?
  city                  String?
  districts             Json     @default("[]")
  searchAmount          String?

  accountType UserType @default(PRIVATE)
  companyName String?
  nip         String?
  website     String?
  address     String?

  interests           Json @default("[]")
  occupations         Json @default("[]")
  searchPreferences   Json @default("[]")
  searchPropertyTypes Json @default("[]")
  noiseCompatibility  Json @default("[]")
  petsCompatibility   Json @default("[]")

  messagesSent         Message[]                 @relation("MessagesSent")
  conversations        ConversationParticipant[]
  properties           Property[]
  roommateInProperties Property[]                @relation("PropertyRoommates")
  bookmarkedProperties PropertyBookmark[]        @relation("UserPropertyBookmarks")
  bookmarkedByUsers    UserBookmark[]            @relation("BookmarkTargetUser")
  bookmarkedUsers      UserBookmark[]            @relation("BookmarkOwnerUser")
  reportsFiled         Report[]                  @relation("ReportsFiled")
  reportsAgainst       Report[]                  @relation("ReportsAgainstUser")
}

model Property {
  id              String         @id @default(uuid())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  type            PropertyType?
  listingType     ListingType
  status          PropertyStatus @default(DRAFT)
  title           String
  description     String?
  price           Int
  deposit         Int?
  city            String
  district        String?
  street          String?
  buildingNumber  String?
  latitude        Float?
  longitude       Float?
  sizeM2          Int?
  rooms           Int?
  floor           Int?
  yearBuilt       Int?
  furnished       Boolean?
  balcony         Boolean?
  elevator        Boolean?
  parking         Boolean?
  desk            Boolean?
  petsAllowed     Boolean?
  separateKitchen Boolean?
  garden          Boolean?
  gymInBuilding   Boolean?
  separateToilet  Boolean?
  smokingAllowed  Boolean?
  internet        Boolean?
  tv              Boolean?
  gas             Boolean?
  electricity     Boolean?
  water           Boolean?
  dryer           Boolean?
  heatingCity     Boolean?
  washingMachine  Boolean?
  dishwasher      Boolean?
  airConditioning Boolean?
  isShared        Boolean?       @default(false)
  roomType        String?
  images          Json           @default("[]")
  mainImageIdx    Int?
  ownerId         String
  email           String?
  phone           String?

  parentId      String?
  parent        Property?  @relation("PropertyHierarchy", fields: [parentId], references: [id])
  subProperties Property[] @relation("PropertyHierarchy")

  owner        User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  roommates    User[]             @relation("PropertyRoommates")
  bookmarkedBy PropertyBookmark[] @relation("PropertyBookmarks")
  reports      Report[]           @relation("ReportsAgainstProperty")
}

model PropertyBookmark {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  userId     String
  propertyId String
  user       User     @relation("UserPropertyBookmarks", fields: [userId], references: [id], onDelete: Cascade)
  property   Property @relation("PropertyBookmarks", fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
}

model UserBookmark {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  userId    String
  targetId  String
  user      User     @relation("BookmarkOwnerUser", fields: [userId], references: [id], onDelete: Cascade)
  target    User     @relation("BookmarkTargetUser", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId])
}

model Conversation {
  id           String                    @id @default(uuid())
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  userAId      String
  userBId      String
  messages     Message[]
  participants ConversationParticipant[]

  @@unique([userAId, userBId], name: "UniqueConversationPair")
}

model ConversationParticipant {
  id                String       @id @default(uuid())
  conversationId    String
  userId            String
  unreadCount       Int          @default(0)
  lastReadMessageId String?
  conversation      Conversation @relation(fields: [conversationId], references: [id])
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(uuid())
  createdAt      DateTime     @default(now())
  content        String
  isRead         Boolean      @default(false)
  senderId       String
  sender         User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Report {
  id                 String       @id @default(uuid())
  createdAt          DateTime     @default(now())
  reason             ReportReason
  description        String?
  reporterId         String
  reporter           User         @relation("ReportsFiled", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUserId     String?
  reportedUser       User?        @relation("ReportsAgainstUser", fields: [reportedUserId], references: [id])
  reportedPropertyId String?
  reportedProperty   Property?    @relation("ReportsAgainstProperty", fields: [reportedPropertyId], references: [id], onDelete: Cascade)
}
